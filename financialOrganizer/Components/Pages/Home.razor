@page "/"
@rendermode InteractiveServer
@using Components.Models;
@using Components.Services;
@using Microsoft.AspNetCore.Authorization
@using System.Globalization
@inject IFinanceService IFinanceService
@inject IJSRuntime JSRuntime
@implements IDisposable

@attribute [Authorize]

<h3>Транзакции</h3>

<div class="mb-4">
    <div class="row">
        <div class="col-md-3">
            <button @onclick="ShowAddDialog" class="btn btn-primary w-100">
                <i class="fas fa-plus"></i> Новая транзакция
            </button>
        </div>
        <div class="col-md-9">
            <div class="form-inline float-right">
                <label class="mr-2">Период:</label>
                <InputDate @bind-Value="StartDate" class="form-control mr-2" />
                <span class="mr-2">—</span>
                <InputDate @bind-Value="EndDate" class="form-control mr-2" />
                <button @onclick="LoadTransactions" class="btn btn-outline-secondary">
                    <i class="fas fa-filter"></i> Фильтр
                </button>
                <button @onclick="ResetFilter" class="btn btn-outline-secondary ml-2">
                    <i class="fas fa-times"></i> Сброс
                </button>
            </div>
        </div>
    </div>
</div>

@if (transactions == null || !transactions.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Нет транзакций за выбранный период.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th>Дата</th>
                    <th>Категория</th>
                    <th>Описание</th>
                    <th class="text-right">Сумма</th>
                    <th class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var transaction in transactions)
                {
                    <tr>
                        <td>@transaction.Date.ToString("dd.MM.yyyy")</td>
                        <td>@transaction.TransactionName</td>
                        <td>@transaction.Description</td>
                        <td class="text-right @(transaction.Type == TransactionType.Income ? "text-success" : "text-danger")">
                            @(transaction.Type == TransactionType.Income ? "+" : "-")
                            @transaction.Amount.ToString("C")
                        </td>
                        <td class="text-center">
                            <button @onclick="() => EditTransaction(transaction)"
                                    class="btn btn-sm btn-outline-primary mr-1"
                                    title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button @onclick="() => DeleteTransaction(transaction)"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="chart-container">
        <div class="chart-container" style="position: relative; height:250px; width:250px">
            <canvas id="expenseChart"></canvas>
        </div>

        <div class="chart-legend mt-3">
            @{
                var legendColors = GetChartColors(categoryExpenses.Count);
                var legendIndex = 0;
            }
            @foreach (var item in categoryExpenses)
            {
                <div class="legend-item">
                    <span class="legend-color" style="background-color: @legendColors[legendIndex]"></span>
                    <span class="legend-label">@item.Key</span>
                    <span class="legend-value">@item.Value.ToString("C0")</span>
                </div>
                legendIndex++;
            }
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Сводка</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <span>Доходы:</span>
                <span class="text-success">@totalIncome.ToString("C")</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Расходы:</span>
                <span class="text-danger">@totalExpenseAmount.ToString("C")</span>
            </div>
            <hr />
            <div class="d-flex justify-content-between">
                <strong>Баланс:</strong>
                <strong class="@(totalBalance >= 0 ? "text-success" : "text-danger")">
                    @totalBalance.ToString("C")
                </strong>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <small class="text-muted">
            Показано @transactions.Count транзакций
        </small>
    </div>
}

@if (showDialog)
{
    <TransactionDialog Transaction="currentTransaction"
                       OnSave="HandleSave"
                       OnCancel="CloseDialog"
                       IsVisible="showDialog" />
}

@code {
    private List<Transaction> transactions = new();
    private List<Category> Categories = new();
    private Transaction currentTransaction = new();
    private bool showDialog = false;
    private DateTime? StartDate = DateTime.Now.AddMonths(-1);
    private DateTime? EndDate = DateTime.Now;

    private decimal totalBalance;
    private decimal totalIncome;
    private decimal totalExpenseAmount;

    private Dictionary<string, decimal> categoryExpenses = new();
    private bool HasExpenses => categoryExpenses.Any();

    private bool chartLoaded = false;
    private DotNetObjectReference<Home>? dotNetHelper;


    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadTransactions();
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            chartLoaded = true;
        }

        if (chartLoaded && HasExpenses)
        {
            await RenderChart();
        }
    }

    private async Task LoadChartJs()
    {
        try
        {
            await JSRuntime.InvokeAsync<bool>("eval", "typeof Chart !== 'undefined'");
            chartLoaded = true;
        }
        catch
        {
            Console.WriteLine("Chart.js не загружен");
        }
    }

    private async Task RenderChart()
    {
        if (categoryExpenses == null || !categoryExpenses.Any())
        {
            return;
        }

        var chartData = new
        {
            canvasId = "expenseChart",
            labels = categoryExpenses.Keys.ToArray(),
            data = categoryExpenses.Values.ToArray(),
            colors = GetChartColors(categoryExpenses.Count)
        };

        await JSRuntime.InvokeVoidAsync("renderExpenseChart", chartData);
    }

    private List<string> GetChartColors(int count)
    {
        return new List<string>
        {
            "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0",
            "#9966FF", "#FF9F40", "#8AC926", "#1982C4",
            "#6A4C93", "#FF595E", "#FFCA3A", "#5FAD56"
        }.Take(count).ToList();
    }

    private async Task LoadCategories()
    {
        Categories = await IFinanceService.GetCategoriesAsync();
    }

    private async Task LoadTransactions()
    {
        try
        {
            if (chartLoaded)
            {
                await JSRuntime.InvokeVoidAsync("clearExpenseChart", "expenseChart");
            }

            transactions = await IFinanceService.GetTransactionsAsync(StartDate, EndDate);

            CalculateTotalBalance();
            CalculateCategoryExpenses();

            if (chartLoaded && HasExpenses)
            {
                await RenderChart();
            }

            StateHasChanged();

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки транзакций: {ex.Message}");
        }
    }

    private void CalculateTotalBalance()
    {
        totalIncome = transactions
            .Where(t => t.Type == TransactionType.Income)
            .Sum(t => t.Amount);

        totalExpenseAmount = transactions
            .Where(t => t.Type == TransactionType.Expense)
            .Sum(t => t.Amount);

        totalBalance = totalIncome - totalExpenseAmount;
    }

    private void CalculateCategoryExpenses()
    {
        categoryExpenses = new Dictionary<string, decimal>();

        var expenseTransactions = transactions
            .Where(t => t.Type == TransactionType.Expense)
            .ToList();

        foreach (var transaction in expenseTransactions)
        {
            string categoryName;

            categoryName = transaction.TransactionName.ToString();

            if (categoryExpenses.ContainsKey(categoryName))
            {
                categoryExpenses[categoryName] += transaction.Amount;
            }
            else
            {
                categoryExpenses[categoryName] = transaction.Amount;
            }
        }

        // Убедимся, что словарь не пустой и правильно сортируется
        categoryExpenses = categoryExpenses
            .OrderByDescending(x => x.Value)
            .ToDictionary(x => x.Key, x => x.Value);
    }

    private void ShowAddDialog()
    {
        currentTransaction = new Transaction
            {
                Date = DateTime.Now,
                Type = TransactionType.Expense
            };
        showDialog = true;
        StateHasChanged();
    }

    private void EditTransaction(Transaction transaction)
    {
        currentTransaction = new Transaction
            {
                Id = transaction.Id,
                Amount = transaction.Amount,
                Date = transaction.Date,
                Description = transaction.Description,
                CategoryId = transaction.CategoryId,
                Type = transaction.Type
            };
        showDialog = true;
        StateHasChanged();
    }

    private async Task HandleSave(Transaction transaction)
    {
        try
        {

            Transaction savedTransaction;

            if (transaction.Id == 0)
            {
                savedTransaction = await IFinanceService.AddTransactionAsync(transaction);

                Console.WriteLine("Добавлена новая транзакция");
            }
            else
            {
                savedTransaction = await IFinanceService.UpdateTransactionAsync(transaction);

                Console.WriteLine("Обновлена существующая транзакция");
            }

            await LoadTransactions();

            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка сохранения транзакции: {ex.Message}");
        }
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Вы уверены, что хотите удалить эту транзакцию?"))
        {
            try
            {
                await IFinanceService.DeleteTransactionAsync(transaction);
                await LoadTransactions();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка удаления транзакции: {ex.Message}");
            }
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        StateHasChanged();
    }

    private async void ResetFilter()
    {
        StartDate = DateTime.Now.AddMonths(-1);
        EndDate = DateTime.Now;
        await LoadTransactions();
    }

    public void Dispose()
    {
        if (chartLoaded)
        {
            _ = JSRuntime.InvokeVoidAsync("clearExpenseChart", "expenseChart");
        }
        dotNetHelper?.Dispose();
    }
}